<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุณุชุนูุงู ูุชุงุฆุฌ ุงูุทูุงุจ</title>
    <!-- ุชุถููู Tailwind CSS ูุณูููุฉ ุงูุชุตููู ูุงูุงุณุชุฌุงุจุฉ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ุชุถููู Font Awesome ูุฃููููุงุช ูุซู ุฃููููุฉ ุงูุชููุฌุฑุงู ูุงููุงุชุณุงุจ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8uR0Hz55J3c1L/2wXoW0/s0T3fA+Q6U7m42vXk4D7VwV5MvV5N5X7g5E2w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- ููุชุจุฉ Confetti ูุชุฃุซูุฑ ุงููุฑูุนุฉ ุนูุฏ ุธููุฑ ุงููุชูุฌุฉ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* ุฅุถุงูุฉ ุฎุท ุนุฑุจู ุนุตุฑู */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* --- ุฅุฎูุงุก ุฃุณูู ุญูู ุงูุฅุฏุฎุงู (Spin Buttons) --- */
        /* ููุชุตูุญุงุช Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* ููุชุตูุญ Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ ูููุงุฌูุฉ -->
    <div class="w-full max-w-md bg-white shadow-2xl rounded-xl p-8 space-y-6">

        <!-- ูุณู ุงูุนููุงู ูุงููุตู (ุชู ุญุฐู ุงูุฅูุถุงุก ูู ููุง) -->
        <div class="text-center space-y-2">
            <h1 id="main-title" class="text-2xl font-bold text-gray-800">ุงุนุฑู ุชุฑุชูุจู ุนูู ุงูุฏูุนุฉ</h1>
            <p id="main-description" class="text-sm text-gray-500">
                ุฃุฏุฎู ุฑูู ุงูุฌููุณ ููุงุณุชุนูุงู.
            </p>
        </div>

        <!-- ูููุฐุฌ ุงูุฅุณุชุนูุงู (Query Form) -->
        <div id="query-section" class="space-space-y-4">
            <label for="seat-number" class="block text-sm font-medium text-gray-700">ุฑูู ุงูุฌููุณ (ID)</label>
            <input type="number" id="seat-number" placeholder="ุตูู ุนูู ุงููุจู" required
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg text-center">
            
            <button id="search-button" onclick="checkResult()"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 disabled:opacity-50">
                ุจุญุซ
            </button>

            <!-- ุฑุณุงูุฉ ุงูุฎุทุฃ (ูุฎููุฉ) -->
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm" role="alert">
                <span class="block sm:inline" id="error-text">ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุฌููุณ ุตุญูุญ.</span>
            </div>
            
             <!-- ุฑุณุงูุฉ ุงูุชุญููู (ูุฎููุฉ) -->
            <p id="loading-message" class="hidden text-xs text-center text-gray-500 pt-2">
                ุฌุงุฑู ุชุญููู ููู ุงููุชุงุฆุฌ ูููุฑุฉ ุงูุฃููู... ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุจุนุถ ุงูููุช.
            </p>
            
             <!-- ุฑุณุงูุฉ ุญุฏูุฏ ุงูุจุญุซ (ูุฎููุฉ) -->
            <div id="limit-message" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative text-sm mt-3" role="alert">
                <span id="limit-text">ููุฏ ูุตูุช ููุญุฏ ุงูุฃูุตู ููุงุณุชุนูุงูุงุช ุงูููููุฉ (8 ูุญุงููุงุช). ูุฑุฌู ุงููุญุงููุฉ ุบุฏุงู.</span>
            </div>
        </div>

        <!-- ูุณู ุนุฑุถ ุงููุชุงุฆุฌ (Result Display) -->
        <div id="result-section" class="hidden space-y-4 pt-4 border-t border-gray-200">
            <div class="bg-white p-6 rounded-lg shadow-inner text-center space-y-4">
                
                <!-- ุงุณู ุงูุทุงูุจ (ูุจูู ููุนุฑุถ ุงูุฃุณุงุณู) -->
                <h2 id="student-name" class="text-xl font-bold text-gray-800 border-b pb-2"></h2>

                <!-- ุญููู ุงูุชุฑุชูุจ ูุงููุณุจุฉ ุงููุฆููุฉ -->
                <div class="grid grid-cols-2 gap-4">
                    
                    <!-- ุญูู ุงูุชุฑุชูุจ (ุชู ูููู ูููููู) -->
                    <div class="p-3 rounded-lg bg-yellow-100 shadow-md">
                        <p class="text-xs font-medium text-yellow-700 mb-1">ุงูุชุฑุชูุจ:</p>
                        <p id="student-rank" class="text-2xl font-extrabold text-yellow-800"></p>
                    </div>

                    <!-- ุญูู ุงููุณุจุฉ ุงููุฆููุฉ (ุชู ูููู ูููุณุงุฑ) -->
                    <div class="p-3 rounded-lg bg-green-100 shadow-md">
                        <p class="text-xs font-medium text-green-700 mb-1">ุงููุณุจุฉ ุงููุฆููุฉ:</p>
                        <p id="student-percentage" class="text-2xl font-extrabold text-green-800"></p>
                    </div>

                </div>

                <!-- ุฑุณุงูุฉ ุชููุฆุฉ ุงุญุชูุงููุฉ -->
                <p class="text-xl font-extrabold text-blue-600 pt-3">ุฃูู ูุจุฑูู ๐ฅณโค๏ธโค๏ธ</p>
                <p id="congrats-message" class="text-sm text-gray-500 pt-1">
                    ุชุงุจุนูุง ุขุฎุฑ ุงูุฃุฎุจุงุฑ ูุงููุตุงุฆุญ ูููุฑุงุญู ุงููุงุฏูุฉ!
                </p>
                
                <!-- ุงูุฅูุถุงุก (ุชู ูููู ุฅูู ููุง) -->
                <p class="text-xs font-medium text-gray-400 text-center pt-4 pb-2 leading-none">
                    ุนุจุฏุงูุฑุญูู ุฑุฌุจ Batch 1
                </p>

                <!-- ุฒุฑ ููุงุฉ ุงูุชููุฌุฑุงู -->
                <a href="https://t.me/Abdelrahman_Ragab1" target="_blank"
                   class="inline-flex items-center justify-center w-full p-3 text-white bg-sky-500 rounded-lg font-semibold hover:bg-sky-600 transition duration-150 shadow-lg shadow-sky-200 mb-2">
                    <i class="fab fa-telegram-plane ml-2 text-xl"></i>
                    ุงูุถู ูููุงุฉ ุงูุชููุฌุฑุงู ุงูุฎุงุตุฉ ุจูุง
                </a>
                
                <!-- ุฒุฑ ูุฌููุนุฉ ุงููุงุชุณุงุจ ุงูุฌุฏูุฏุฉ -->
                <!-- ุชู ุชุญุฏูุซ ุฑุงุจุท ููุณูู ุงููุฑูุฉ ููุง ุฅูู "ูุฑูุฉ ุซุงูุซุฉ" -->
                <a href="https://chat.whatsapp.com/L8d0c706CeEDiRFlys6rTD" target="_blank"
                   class="inline-flex items-center justify-center w-full p-3 text-white bg-green-500 rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow-lg shadow-green-200">
                    <i class="fab fa-whatsapp ml-2 text-xl"></i>
                    ุฌุฑูุจ "ุณุงุนุฏ ูุชุณุนุฏ" (ูุฑูุฉ ุซุงูุซุฉ)
                </a>
            </div>

            <!-- ุฒุฑ ุงูุนูุฏุฉ -->
            <button onclick="resetApp()" class="w-full text-blue-600 font-semibold text-center hover:text-blue-800 transition duration-150 mt-4">
                ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ (ุงุณุชุนูุงู ุฌุฏูุฏ)
            </button>
        </div>
    </div>

    <!-- ููุฏ JavaScript ููุฑุจุท ุจู Google Sheets ูุฅุฏุงุฑุฉ ุญุฏูุฏ ุงูุจุญุซ -->
    <script>
        // *************** ุฅุนุฏุงุฏุงุช Google Sheets ***************
        // ุชู ุชุญุฏูุซ ูุนุฑู ุงูุดูุช (SPREADSHEET_ID)
        const SPREADSHEET_ID = '1f3DxNf5xl4MKjKg7DQRi1ElReahayceZZdjTOX-Kc9A';
        const SPREADSHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;
        
        // *************** ุฅุนุฏุงุฏุงุช ุญุฏูุฏ ุงูุจุญุซ ***************
        const MAX_SEARCHES = 8;
        const SEARCH_KEY = 'dailySearchCount';
        const TIMESTAMP_KEY = 'lastSearchTimestamp';

        let allResults = [];
        let isDataLoaded = false;
        
        // ุงููุชุบูุฑุงุช ุงูุฎุงุตุฉ ุจุงููุงุฌูุฉ
        const seatNumberInput = document.getElementById('seat-number');
        const searchButton = document.getElementById('search-button');
        const querySection = document.getElementById('query-section');
        const resultSection = document.getElementById('result-section');
        const errorMessage = document.getElementById('error-message');
        const loadingMessage = document.getElementById('loading-message');
        const limitMessage = document.getElementById('limit-message');

        // ุนูุงุตุฑ ุงูุนููุงู ุงูุฑุฆูุณูุฉ
        const mainTitle = document.getElementById('main-title');
        const mainDescription = document.getElementById('main-description');

        // --- ุฏุงูุฉ ุฅุฏุงุฑุฉ ุญุฏูุฏ ุงูุจุญุซ ุงูููููุฉ ---
        function checkSearchLimit() {
            const count = parseInt(localStorage.getItem(SEARCH_KEY) || '0');
            const timestamp = parseInt(localStorage.getItem(TIMESTAMP_KEY) || '0');
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000; // 24 ุณุงุนุฉ ุจุงููููู ุซุงููุฉ

            // ุฅุฐุง ูุฑ 24 ุณุงุนุฉ ุนูู ุฃูู ุนูููุฉ ุจุญุซุ ูุชู ุชุตููุฑ ุงูุนุฏุงุฏ
            if (now - timestamp > oneDay) {
                localStorage.setItem(SEARCH_KEY, '0');
                localStorage.setItem(TIMESTAMP_KEY, now.toString()); // ุชุญุฏูุซ ุงูููุช ุนูุฏ ุงูุชุตููุฑ
                limitMessage.classList.add('hidden');
                return true; // ูุณููุญ ุจุงูุจุญุซ
            }

            if (count >= MAX_SEARCHES) {
                searchButton.disabled = true;
                limitMessage.classList.remove('hidden');
                return false; // ุบูุฑ ูุณููุญ ุจุงูุจุญุซ
            }
            
            limitMessage.classList.add('hidden');
            return true; // ูุณููุญ ุจุงูุจุญุซ
        }

        // ุชุณุฌูู ูุญุงููุฉ ุจุญุซ ูุงุฌุญุฉ
        function recordSearchAttempt() {
            let count = parseInt(localStorage.getItem(SEARCH_KEY) || '0');
            let timestamp = parseInt(localStorage.getItem(TIMESTAMP_KEY) || '0');
            const now = Date.now();
            
            if (timestamp === 0) {
                 // ุฅุฐุง ูุงูุช ุฃูู ูุญุงููุฉ ูู ุฏูุฑุฉ 24 ุณุงุนุฉ
                 localStorage.setItem(TIMESTAMP_KEY, now.toString());
            }
            
            count++;
            localStorage.setItem(SEARCH_KEY, count.toString());
        }

        // ุฏุงูุฉ ุฅุทูุงู ุชุฃุซูุฑ ุงููุฑูุนุฉ (Confetti)
        function launchConfetti() {
            if (window.confetti) {
                // ุฅุทูุงู ุฏูุนุฉ ูููุฉ ูู ุงูุฃุนูู
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.6 }
                });
                // ุฅุทูุงู ุฏูุนุชูู ูู ุงูุฌุงูุจูู ูููุก ุงูุดุงุดุฉ
                confetti({
                    particleCount: 100,
                    angle: 60,
                    spread: 80,
                    origin: { x: 0 }
                });
                confetti({
                    particleCount: 100,
                    angle: 120,
                    spread: 80,
                    origin: { x: 1 }
                });
            }
        }

        // ุฏุงูุฉ ูุฌูุจ ุงูุจูุงูุงุช ูู Google Sheets
        async function fetchResultsFromSheet() {
            loadingMessage.classList.remove('hidden');
            searchButton.disabled = true;

            try {
                let response;
                let attempts = 0;
                const maxAttempts = 3;

                while (attempts < maxAttempts) {
                    try {
                        response = await fetch(SPREADSHEET_URL);
                        if (response.ok) break;
                        
                        if (attempts < maxAttempts - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempts)));
                        }
                    } catch (e) {
                         if (attempts < maxAttempts - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempts)));
                        } else {
                             throw e;
                        }
                    }
                    attempts++;
                }

                if (!response || !response.ok) {
                    throw new Error(`HTTP error! status: ${response ? response.status : 'Network Failed'}`);
                }
                
                const text = await response.text();
                
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                
                if (data.table && data.table.rows) {
                    allResults = data.table.rows.map(row => {
                        
                        const seatNumberData = row.c[0];
                        const nameData = row.c[1];
                        const percentageData = row.c[2];
                        const rankData = row.c[3];

                        const seatNumber = seatNumberData ? seatNumberData.v : null;
                        const name = nameData ? nameData.v : 'ุบูุฑ ูุนุฑูู';

                        let percentageValue = 'N/A';
                        if (percentageData && percentageData.v !== null) {
                             // ุงูุชุนุงูู ูุน ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ (ูุซูุงู 0.95)
                            percentageValue = (parseFloat(percentageData.v) * 100).toFixed(2);
                        } else if (percentageData && percentageData.f) {
                            // ุงูุชุนุงูู ูุน ุงูููู ุงูููุณูุฉ ููุต (ูุซูุงู "95.00%")
                             percentageValue = percentageData.f.replace('%', '').trim();
                        }
                        const percentage = `${percentageValue}%`;
                        
                        const rank = rankData ? rankData.v : 'N/A';
                        
                        return { seatNumber: String(seatNumber), name, percentage, rank: String(rank) }; 
                    }).filter(r => r.seatNumber !== 'null');

                    isDataLoaded = true;
                    console.log(`Successfully loaded ${allResults.length} records from Google Sheet.`);
                } else {
                    throw new Error("Invalid data structure received from Google Sheet.");
                }

            } catch (error) {
                console.error("Error fetching or parsing Google Sheet data:", error);
                document.getElementById('error-text').textContent = 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ููู ุงููุชุงุฆุฌ. (ุชุฃูุฏ ูู ุงูุฑุงุจุท ูุงููุดุฑ).';
                errorMessage.classList.remove('hidden');
                isDataLoaded = false;
            } finally {
                loadingMessage.classList.add('hidden');
                updateSearchButtonState();
            }
        }

        // ุฏุงูุฉ ูุญุต ูุนุฑุถ ุงููุชูุฌุฉ
        window.checkResult = async () => {
            if (!checkSearchLimit()) return; // ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู ูุจู ุงูุจุฏุก

            const id = seatNumberInput.value.trim();
            errorMessage.classList.add('hidden');
            searchButton.disabled = true;
            searchButton.textContent = '... ุฌุงุฑู ุงูุจุญุซ';

            if (!id) {
                document.getElementById('error-text').textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุงูุฌููุณ ุฃููุงู.';
                errorMessage.classList.remove('hidden');
                searchButton.textContent = 'ุจุญุซ';
                updateSearchButtonState();
                return;
            }

            if (!isDataLoaded) {
                await fetchResultsFromSheet();
                if (!isDataLoaded) {
                     searchButton.textContent = 'ุจุญุซ';
                     return;
                }
            }
            
            const student = allResults.find(s => s.seatNumber === String(id));

            if (student) {
                // ุชุณุฌูู ูุญุงููุฉ ุงูุจุญุซ ุงููุงุฌุญุฉ
                recordSearchAttempt();
                
                // ุนุฑุถ ุจูุงูุงุช ุงูุทุงูุจ
                document.getElementById('student-name').textContent = student.name;
                document.getElementById('student-percentage').textContent = student.percentage;
                document.getElementById('student-rank').textContent = student.rank;
                
                // ุฅุฎูุงุก ุงูุนููุงู ูุงููุตู ุงูุฑุฆูุณู ุนูุฏ ุธููุฑ ุงููุชูุฌุฉ
                mainTitle.classList.add('hidden');
                mainDescription.classList.add('hidden');

                // ุชุจุฏูู ุงูุฃูุณุงู
                querySection.classList.add('hidden');
                resultSection.classList.remove('hidden');

                // ุฅุทูุงู ุชุฃุซูุฑ ุงููุฑูุนุฉ ููุงุญุชูุงู
                launchConfetti();

            } else {
                // ุญุงูุฉ ุนุฏู ุงูุนุซูุฑ ุนูู ุงูุทุงูุจ - ูุง ุชุณุฌู ููุญุงููุฉ (ูุชุดุฌูุน ุงููุญุงููุฉ ุงูุตุญูุญุฉ)
                document.getElementById('error-text').textContent = `ุนุฐุฑุงูุ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ ูุฑูู ุงูุฌููุณ ${id}. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุงูุฑูู ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.`;
                errorMessage.classList.remove('hidden');
            }
            
            searchButton.textContent = 'ุจุญุซ';
            updateSearchButtonState();
        }

        // ุฏุงูุฉ ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุงูุจุญุซ
        function updateSearchButtonState() {
            // ูุชู ุชูุนูู ุงูุฒุฑ ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ูุฏ ุญููุช ููุงูุช ููุงู ูููุฉ ูู ุญูู ุงูุฅุฏุฎุงู ููู ูุชู ุชุฌุงูุฒ ุงูุญุฏ
            searchButton.disabled = seatNumberInput.value.length === 0 || !isDataLoaded || !checkSearchLimit();
        }

        // ุฏุงูุฉ ุฅุนุงุฏุฉ ุชุนููู ุงูุชุทุจูู ููุงุณุชุนูุงู ุงูุฌุฏูุฏ
        window.resetApp = () => {
            seatNumberInput.value = '';
            searchButton.disabled = true;
            errorMessage.classList.add('hidden');
            
            // ุฅุธูุงุฑ ุงูุนููุงู ูุงููุตู ุงูุฑุฆูุณู ุนูุฏ ุงูุนูุฏุฉ
            mainTitle.classList.remove('hidden');
            mainDescription.classList.remove('hidden');

            querySection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            updateSearchButtonState();
        }

        // ุงูุฅุนุฏุงุฏ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = () => {
            seatNumberInput.addEventListener('input', updateSearchButtonState);
            // ุงุจุฏุฃ ุชุญููู ุงูุจูุงูุงุช ููุฑูุง ุนูุฏ ุชุญููู ุงูุตูุญุฉ ูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู
            fetchResultsFromSheet(); 
            checkSearchLimit();
        };
    </script>

</body>
</html>
